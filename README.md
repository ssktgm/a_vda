配車調整アプリ 設計書

1. アプリ概要

本アプリは、少年サッカーチームや地域団体など、複数台の車で移動する際の配車（車両割り当て）を支援するWebアプリケーションである。

PWA (Progressive Web App) に対応しており、オフラインでの動作や、スマートフォン端末のホーム画面へのインストールが可能。データはすべてクライアントサイド（ブラウザ内）のIndexedDBに保存され、サーバーを必要としない。

2. 主な機能

2.1. 配車調整機能 (index.html)

ステップ1: 参加者選択

IndexedDBからマスターデータを読み込み、家族単位で参加者を表示。

家族ごと、または個人ごとに参加を選択可能。

「同乗優先」が有効なメンバー（主に選手）には、学年・学校などの情報入力欄が表示される。

ステップ2: 車・ドライバー選択

マスターデータから車リストを表示。

使用する車と、その車のドライバー（参加者から選択）を指定する。

「荷物あり」チェックにより、定員を自動的に2名（ドライバー含む）に変更する機能。

ステップ3: 別便除外

ステップ1で選択した参加者のうち、配車対象外（現地集合など）のメンバーを除外する。

ステップ4: 駐車場・グラウンド情報入力

グラウンド名（必須）を入力。

指定駐車場の名称、台数制限、備考（地図URLなど）を入力。

「その他駐車場」の名称、備考を入力。

ステップ5: 割り当て実行

以下のロジックに基づき、参加者を自動で車に割り当てる。

ステップ6: 割り当て結果表示・調整

駐車場ごと（指定・その他・別便）にカード形式で車と乗員を表示。

手動調整: チェックボックスによるスワップ機能。

2つの座席（乗員、空席、ドライバー席）を選択して入れ替え。

2台の車を選択して、駐車場（指定/その他）または表示順序を入れ替え。

ステップ7: テキスト出力

割り当て結果をLINEやメールで共有しやすい形式のテキストとして生成し、クリップボードにコピーする機能。

2.2. データ管理機能 (index.html / master.html)

マスターデータ管理 (master.html)

家族、参加者（選手・保護者等）の追加・編集・削除。

参加者の「同乗優先 (isFlagTarget)」フラグの管理。

家族の表示順序の並び替え。

車両の追加・編集・削除。（IDは c + タイムスタンプで自動採番）

マスターデータ（家族、車、保存済み駐車場）のJSONエクスポート（バックアップ）。

マスターデータ（家族、車、保存済み駐車場）のJSONインポート（上書き復元）。

作業状態の永続化 (index.html)

現在の作業状態（全ステップの入力内容、割り当て結果）に名前を付けてIndexedDBに保存（最大5件、古いものから自動削除）。

保存した状態をリストから選択し、復元または削除する機能。

駐車場（グラウンド）ルールの永続化 (index.html)

ステップ4で入力した「グラウンド名」と「指定駐車場の情報」をセットでIndexedDBに保存（最大20件、古いものから自動削除）。

保存したルールをリストから選択し、入力欄に復元または削除する機能。

データ初期化 (index.html)

IndexedDB内の全データ（マスター、状態、駐車場）を消去し、アプリを初期状態に戻す機能。

2.3. PWA対応

Web App Manifest (manifest.json)

アプリ名、アイコン、表示モード（スタンドアロン）を指定。

Service Worker (sw.js)

アプリのコアファイル（HTML, JS, CSS）をキャッシュし、オフラインでもアプリが起動できるようにする。

3. 自動割り当てロジック (allocateParticipants)

ドライバーの配置: 選択された各車に、指定されたドライバーを配置する。

家族の優先割り当て: ドライバーと同じ家族のメンバーが「参加者」にいる場合、優先的にそのドライバーの車に割り当てる（保護者 > 兄弟 > 選手の順）。

同乗優先メンバーの割り当て:

残りの参加者のうち、「同乗優先 (isFlagTarget)」が true のメンバー（選手など）を処理する。

各メンバーについて、すべての車を評価し、「学年」「学校」「その他」が一致する既存乗員が最も多い車を「最適候補」とする。

最適候補の車（複数ある場合はランダム）に割り当てる。

割り当て先がない（どの車にも一致する人がいない）場合は一時保留する。

残りメンバーの割り当て:

「同乗優先」が false のメンバーと、一時保留されたメンバーを、空席がある車に順次割り当てていく。

4. 使用技術

フロントエンド: HTML5, CSS3, JavaScript (ES Modules)

スタイリング: Tailwind CSS (CDN)

データ永続化: IndexedDB

PWA: Web App Manifest, Service Worker

5. データ構造 (IndexedDB)

DB名: CarDispatchDB

バージョン: 3

5.1. families ストア

キーパス: familyName

概要: 家族およびその構成員のマスターデータ。

データ例:

{
  "familyName": "鈴木家",
  "order": 0,
  "members": [
    {
      "id": "p1",
      "name": "鈴木太郎",
      "type": "選手",
      "isFlagTarget": true,
      "data": { "grade": "5年", "school": "東小" }
    },
    {
      "id": "p2",
      "name": "鈴木父",
      "type": "保護者",
      "isFlagTarget": false,
      "data": { "memo": "コーチ" }
    }
  ]
}



5.2. cars ストア

キーパス: id

概要: 車両のマスターデータ。

データ例:

{
  "id": "c1699117835824",
  "name": "鈴木カー",
  "familyName": "鈴木家",
  "baseCapacity": 8
}



5.3. savedStates ストア

キーパス: id (autoIncrement)

インデックス: timestamp

概要: index.html の作業状態のスナップショット。

データ例:

{
  "id": 1,
  "name": "4/1 SF遠征",
  "timestamp": 1699117900000,
  "state": {
    "selectedParticipantIds": ["p1", "p2", "p3"],
    "selectedCarIds": ["c1699117835824"],
    "selectedDrivers": [["c1699117835824", "p2"]],
    "selectedLuggage": [],
    "excludedParticipantIds": [],
    "participantData": [["p1", {"grade": "5年", "school": "東小"}]],
    "currentAssignments": [ /* 割り当て結果オブジェクトの配列 */ ],
    "parkingInfo": {
      "groundName": "SF (高柳)",
      "designated": { "name": "A面", "limit": 6, "memo": "地図URL" },
      "other": { "name": "丘の上", "memo": "" }
    }
  }
}



5.4. savedParking ストア

キーパス: id (autoIncrement)

インデックス: groundName, timestamp

概要: グラウンドと指定駐車場のルールセット。

データ例:

{
  "id": 1,
  "groundName": "SF (高柳)",
  "parkingInfo": {
    "name": "A面（役員専用）",
    "limit": 4,
    "memo": "テニスコート脇"
  },
  "timestamp": 1699118000000
}



6. ファイル構成

index.html: メインの配車調整アプリケーション。

master.html: 選手名簿と車リストを管理するマスターデータ管理ページ。

manual.html: 利用マニュアル。

db.js: IndexedDBの操作（CRUD、DBバージョン管理）を抽象化するヘルパーモジュール。

manifest.json: PWA設定ファイル。

sw.js: オフライン動作を実現するサービスワーカー。
